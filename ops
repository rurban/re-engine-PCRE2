{"version":1,"ops":[{"type":3,"author":{"id":"aef584d35767ca3a7a454b62a1a488f95f4439e6"},"timestamp":1592905773,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY0ODAzNTI0NA==","github-url":"https://github.com/rurban/re-engine-PCRE2/issues/37#issuecomment-648035244"},"message":"I can reduce it to:\n\n~~~~\n$ cat t/s.t \nuse strict;\nuse Test::More tests =\u003e 2;\nuse re::engine::PCRE2;\n\n$_ = \"ab\";\n$_ =~ s/a//;\nis($_, 'b', q(s/a//; 'ab' =\u003e 'b'));\n\n$_ = \"a\";\n$_ =~ s/./2/e;\nis($_, \"2\", q(s/./1+1/eg; 'a' =\u003e '2'));\n\n[test@fedora-33 re-engine-PCRE2-0.16]$ while (perl -Mblib t/s.t); do :; done\n1..2\nok 1 - s/a//; 'ab' =\u003e 'b'\nok 2 - s/./1+1/eg; 'a' =\u003e '2'\n1..2\nok 1 - s/a//; 'ab' =\u003e 'b'\nok 2 - s/./1+1/eg; 'a' =\u003e '2'\n1..2\nok 1 - s/a//; 'ab' =\u003e 'b'\nok 2 - s/./1+1/eg; 'a' =\u003e '2'\nfree(): double free detected in tcache 2\nAborted (core dumped)\n~~~~\n\nIt's triggered by s///e substituting on a variable that was substituted before. It does not have to be the implicit $_. It can be any other variable. Removing the /e flag disappears the bug.","files":null},{"type":3,"author":{"id":"aef584d35767ca3a7a454b62a1a488f95f4439e6"},"timestamp":1592906367,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY0ODA0MDQ3Mw==","github-url":"https://github.com/rurban/re-engine-PCRE2/issues/37#issuecomment-648040473"},"message":"Valgrind reports on each run:\n\n~~~~\n$ while (valgrind -- perl -Mblib t/s.t); do :; done\n[...]\n1..2\nok 1 - s/a//; 'ab' =\u003e 'b'\nok 2 - s/./1+1/eg; 'a' =\u003e '2'\n==29384== Invalid free() / delete / delete[] / realloc()\n==29384==    at 0x483A9F5: free (vg_replace_malloc.c:538)\n==29384==    by 0x4913A5A: Perl_pregfree2 (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x4975859: Perl_sv_clear (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x4976001: Perl_sv_free2 (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x48AED22: Perl_op_clear (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x48AEE0C: Perl_op_free (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x48D138D: perl_destruct (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x109323: main (perlmain.c:138)\n==29384==  Address 0x6785510 is 0 bytes inside a block of size 10 free'd\n==29384==    at 0x483A9F5: free (vg_replace_malloc.c:538)\n==29384==    by 0x4970003: Perl_pp_subst (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x4967875: Perl_runops_standard (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x48D6C83: perl_run (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x109349: main (perlmain.c:127)\n==29384==  Block was alloc'd at\n==29384==    at 0x4839809: malloc (vg_replace_malloc.c:307)\n==29384==    by 0x49477BC: Perl_safesysmalloc (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x497F9A7: Perl_sv_grow (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x4986B07: Perl_sv_setpvn (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x4986CD7: Perl_newSVpvn_flags (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x496F947: Perl_pp_subst (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x4967875: Perl_runops_standard (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x48D6C83: perl_run (in /usr/lib64/libperl.so.5.32.0)\n==29384==    by 0x109349: main (perlmain.c:127)\n~~~~","files":null},{"type":3,"author":{"id":"aef584d35767ca3a7a454b62a1a488f95f4439e6"},"timestamp":1592907005,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY0ODA0NTYzNw==","github-url":"https://github.com/rurban/re-engine-PCRE2/issues/37#issuecomment-648045637"},"message":"Here a the line numbers:\n\n~~~~\n==81403== Invalid free() / delete / delete[] / realloc()\n==81403==    at 0x483A9F5: free (vg_replace_malloc.c:538)\n==81403==    by 0x4906A5A: Perl_pregfree2 (regcomp.c:21623)\n==81403==    by 0x4968859: Perl_sv_clear (sv.c:6670)\n==81403==    by 0x4969001: Perl_sv_free2 (sv.c:7132)\n==81403==    by 0x48A1D22: Perl_SvREFCNT_dec (inline.h:235)\n==81403==    by 0x48A1D22: Perl_op_clear (op.c:1151)\n==81403==    by 0x48A1E0C: Perl_op_free (op.c:957)\n==81403==    by 0x48A1E0C: Perl_op_free (op.c:847)\n==81403==    by 0x48C438D: perl_destruct (perl.c:881)\n==81403==    by 0x109323: main (perlmain.c:138)\n==81403==  Address 0x6530da0 is 0 bytes inside a block of size 10 free'd\n==81403==    at 0x483A9F5: free (vg_replace_malloc.c:538)\n==81403==    by 0x4963003: Perl_pp_subst (pp_hot.c:4501)\n==81403==    by 0x495A875: Perl_runops_standard (run.c:41)\n==81403==    by 0x48C9C83: S_run_body (perl.c:2761)\n==81403==    by 0x48C9C83: perl_run (perl.c:2684)\n==81403==    by 0x109349: main (perlmain.c:127)\n==81403==  Block was alloc'd at\n==81403==    at 0x4839809: malloc (vg_replace_malloc.c:307)\n==81403==    by 0x493A7BC: Perl_safesysmalloc (util.c:155)\n==81403==    by 0x49729A7: Perl_sv_grow (sv.c:1616)\n==81403==    by 0x4979B07: Perl_sv_setpvn (sv.c:4993)\n==81403==    by 0x4979CD7: Perl_newSVpvn_flags (sv.c:9352)\n==81403==    by 0x4962947: Perl_pp_subst (pp_hot.c:4433)\n==81403==    by 0x495A875: Perl_runops_standard (run.c:41)\n==81403==    by 0x48C9C83: S_run_body (perl.c:2761)\n==81403==    by 0x48C9C83: perl_run (perl.c:2684)\n==81403==    by 0x109349: main (perlmain.c:127)\n~~~~","files":null},{"type":2,"author":{"id":"5435141a73302fae7cf7a526794e1018ba2157ae"},"timestamp":1592922137,"metadata":{"github-id":"MDE3OlJlbmFtZWRUaXRsZUV2ZW50MzQ3MzIwODM5MQ=="},"title":"t/s.t fails and crashes with Perl 5.32.0 randomly","was":"t/s.t fails and crashes with Perl 5.32.0 randomly"},{"type":5,"author":{"id":"5435141a73302fae7cf7a526794e1018ba2157ae"},"timestamp":1592922154,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDM0NzMyMDk4MzE="},"added":["bug"],"removed":[]},{"type":3,"author":{"id":"aef584d35767ca3a7a454b62a1a488f95f4439e6"},"timestamp":1593179510,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1MDE5MTIzNw==","github-url":"https://github.com/rurban/re-engine-PCRE2/issues/37#issuecomment-650191237"},"message":"The failure happens since this perl commit \u003chttps://github.com/Perl/perl5/commit/f0ac8a377ab01ad6936776b0c73d0c1eab98f782\u003e:\n\n~~~~\ncommit f0ac8a377ab01ad6936776b0c73d0c1eab98f782 (refs/bisect/bad)\nAuthor: Karl Williamson \u003ckhw@cpan.org\u003e\nDate:   Wed Feb 12 16:40:29 2020 -0700\n\n    op.h: Move some flag bits down\n    \n    This is in preparation for adding a new flag bit at the end in a future\n    commit.  It could have been added in the unused space that the first of\n    these was moved to, but the new one is less important/used, so I thought\n    it best to come last.  The reason to use unused space is to preserve\n    binary compatibility with the bits, and we don't care about that at this\n    point in the development cycle.\n~~~~","files":null},{"type":3,"author":{"id":"5435141a73302fae7cf7a526794e1018ba2157ae"},"timestamp":1601031944,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY5ODg2NzE4MA==","github-url":"https://github.com/rurban/re-engine-PCRE2/issues/37#issuecomment-698867180"},"message":"gdb bt\n`$ gdb --args perl5.32.0d-nt -Iblib/arch -Iblib/lib t/s.t`\n```\ndouble free or corruption (out)\n\nProgram received signal SIGABRT, Aborted.\n0x00007ffff7c4c9e5 in raise () from /lib64/libc.so.6\n(gdb) bt\n#0  0x00007ffff7c4c9e5 in raise () from /lib64/libc.so.6\n#1  0x00007ffff7c35895 in abort () from /lib64/libc.so.6\n#2  0x00007ffff7c90857 in __libc_message () from /lib64/libc.so.6\n#3  0x00007ffff7c97d7c in malloc_printerr () from /lib64/libc.so.6\n#4  0x00007ffff7c993c0 in _int_free () from /lib64/libc.so.6\n#5  0x0000000000597839 in Perl_safesysfree (where=0x1149310) at util.c:399\n#6  0x0000000000573652 in Perl_pregfree2 (rx=0x112e640) at regcomp.c:21623\n#7  0x000000000063be8f in Perl_sv_clear (orig_sv=0x112e640) at sv.c:6670\n#8  0x000000000063effd in Perl_sv_free2 (sv=0x112e640, rc=1) at sv.c:7132\n#9  0x000000000042264e in Perl_SvREFCNT_dec (sv=0x112e640) at inline.h:235\n#10 0x000000000042608b in Perl_op_clear (o=0x1129a98) at op.c:1157\n#11 0x0000000000425bb1 in Perl_op_free (o=0x1129a98) at op.c:957\n#12 0x00000000004673f4 in perl_destruct (my_perl=0xa802a0) at perl.c:881\n#13 0x0000000000420179 in main (argc=4, argv=0x7fffffffd268, env=0x7fffffffd290) at perlmain.c:138\n```","files":null},{"type":6,"author":{"id":"5435141a73302fae7cf7a526794e1018ba2157ae"},"timestamp":1601031944,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDAyNDg3OTU0"},"target":"987a6294e21d9a0283592b6af81699a693e03e14fafc39a626a528821b94db89","message":"Introduced with v5.31.9\n\ngdb bt\n\n`$ gdb --args perl5.32.0d-nt -Iblib/arch -Iblib/lib t/s.t`\n```\ndouble free or corruption (out)\n\nProgram received signal SIGABRT, Aborted.\n0x00007ffff7c4c9e5 in raise () from /lib64/libc.so.6\n(gdb) bt\n#0  0x00007ffff7c4c9e5 in raise () from /lib64/libc.so.6\n#1  0x00007ffff7c35895 in abort () from /lib64/libc.so.6\n#2  0x00007ffff7c90857 in __libc_message () from /lib64/libc.so.6\n#3  0x00007ffff7c97d7c in malloc_printerr () from /lib64/libc.so.6\n#4  0x00007ffff7c993c0 in _int_free () from /lib64/libc.so.6\n#5  0x0000000000597839 in Perl_safesysfree (where=0x1149310) at util.c:399\n#6  0x0000000000573652 in Perl_pregfree2 (rx=0x112e640) at regcomp.c:21623\n#7  0x000000000063be8f in Perl_sv_clear (orig_sv=0x112e640) at sv.c:6670\n#8  0x000000000063effd in Perl_sv_free2 (sv=0x112e640, rc=1) at sv.c:7132\n#9  0x000000000042264e in Perl_SvREFCNT_dec (sv=0x112e640) at inline.h:235\n#10 0x000000000042608b in Perl_op_clear (o=0x1129a98) at op.c:1157\n#11 0x0000000000425bb1 in Perl_op_free (o=0x1129a98) at op.c:957\n#12 0x00000000004673f4 in perl_destruct (my_perl=0xa802a0) at perl.c:881\n#13 0x0000000000420179 in main (argc=4, argv=0x7fffffffd268, env=0x7fffffffd290) at perlmain.c:138\n```","files":null},{"type":6,"author":{"id":"5435141a73302fae7cf7a526794e1018ba2157ae"},"timestamp":1601031989,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDAyNDg4MDY3"},"target":"987a6294e21d9a0283592b6af81699a693e03e14fafc39a626a528821b94db89","message":"Introduced with v5.31.9\n\ngdb bt\n\n`$ gdb --args perl5.32.0d-nt -Iblib/arch -Iblib/lib t/s.t`\n```\ndouble free or corruption (out)\n\nProgram received signal SIGABRT, Aborted.\n0x00007ffff7c4c9e5 in raise () from /lib64/libc.so.6\n(gdb) bt\n#0  0x00007ffff7c4c9e5 in raise () from /lib64/libc.so.6\n#1  0x00007ffff7c35895 in abort () from /lib64/libc.so.6\n#2  0x00007ffff7c90857 in __libc_message () from /lib64/libc.so.6\n#3  0x00007ffff7c97d7c in malloc_printerr () from /lib64/libc.so.6\n#4  0x00007ffff7c993c0 in _int_free () from /lib64/libc.so.6\n#5  0x0000000000597839 in Perl_safesysfree (where=0x1149310) at util.c:399\n#6  0x0000000000573652 in Perl_pregfree2 (rx=0x112e640) at regcomp.c:21623\n#7  0x000000000063be8f in Perl_sv_clear (orig_sv=0x112e640) at sv.c:6670\n#8  0x000000000063effd in Perl_sv_free2 (sv=0x112e640, rc=1) at sv.c:7132\n#9  0x000000000042264e in Perl_SvREFCNT_dec (sv=0x112e640) at inline.h:235 (REFCNT=0)\n#10 0x000000000042608b in Perl_op_clear (o=0x1129a98) at op.c:1157 (pp_subst)\n#11 0x0000000000425bb1 in Perl_op_free (o=0x1129a98) at op.c:957\n#12 0x00000000004673f4 in perl_destruct (my_perl=0xa802a0) at perl.c:881\n#13 0x0000000000420179 in main (argc=4, argv=0x7fffffffd268, env=0x7fffffffd290) at perlmain.c:138\n```","files":null},{"type":6,"author":{"id":"5435141a73302fae7cf7a526794e1018ba2157ae"},"timestamp":1601032399,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6NDAyNDg5MjE1"},"target":"987a6294e21d9a0283592b6af81699a693e03e14fafc39a626a528821b94db89","message":"Introduced with v5.31.9\n\ngdb bt\n\n`$ gdb --args perl5.32.0d-nt -Iblib/arch -Iblib/lib t/s.t`\n```\ndouble free or corruption (out)\n\nProgram received signal SIGABRT, Aborted.\n0x00007ffff7c4c9e5 in raise () from /lib64/libc.so.6\n(gdb) bt\n#0  0x00007ffff7c4c9e5 in raise () from /lib64/libc.so.6\n#1  0x00007ffff7c35895 in abort () from /lib64/libc.so.6\n#2  0x00007ffff7c90857 in __libc_message () from /lib64/libc.so.6\n#3  0x00007ffff7c97d7c in malloc_printerr () from /lib64/libc.so.6\n#4  0x00007ffff7c993c0 in _int_free () from /lib64/libc.so.6\n#5  0x0000000000597839 in Perl_safesysfree (where=0x1149310) at util.c:399\n#6  0x0000000000573652 in Perl_pregfree2 (rx=0x112e640) at regcomp.c:21623\n#7  0x000000000063be8f in Perl_sv_clear (orig_sv=0x112e640) at sv.c:6670\n#8  0x000000000063effd in Perl_sv_free2 (sv=0x112e640, rc=1) at sv.c:7132\n#9  0x000000000042264e in Perl_SvREFCNT_dec (sv=0x112e640) at inline.h:235 (REFCNT=0)\n#10 0x000000000042608b in Perl_op_clear (o=0x1129a98) at op.c:1157 (pp_subst)\n#11 0x0000000000425bb1 in Perl_op_free (o=0x1129a98) at op.c:957\n#12 0x00000000004673f4 in perl_destruct (my_perl=0xa802a0) at perl.c:881\n#13 0x0000000000420179 in main (argc=4, argv=0x7fffffffd268, env=0x7fffffffd290) at perlmain.c:138\n```\n\nI dont see yet any fault in f0ac8a377ab01ad6936776b0c73d0c1eab98f782, more likely in the next commit.","files":null}]}